#!/usr/bin/env bash

red () {
    printf "\033[31m${1}\033[0m\n"
}

yellow () {
    printf "\033[33m${1}\033[0m\n"
}

green () {
    printf "\033[32m${1}\033[0m\n"
}

yellow "* Reading .env"
source .env
export PACTA_SOURCE PACTA_INPUT PACTA_OUTPUT
echo "PACTA_INPUT: $PACTA_SOURCE"
echo "PACTA_INPUT: $PACTA_INPUT"
echo "PACTA_OUTPUT: $PACTA_OUTPUT"

yellow "* Setting up fresh test input/ and output/ directories"
rm -rf $PACTA_OUTPUT $PACTA_INPUT
bash bin/setup-io

yellow "* Ensuring working_dir/ has the expected file-system structure"
bash bin/mkdir-working_dir

yellow "* IO tree at the start"
./bin/tree-io
echo

docker-compose up --build
echo

yellow "* IO tree at the end"
actual=$(tempfile)
./bin/tree-io > "$actual"
echo

difference=$(diff "$actual" tests/bash/snapshots/results-tree.txt)
if [[ $difference != "" ]]
then
  red "* The output tree is NOT as expected. Difference:"
  red $difference
else
  green "* Good to go."
fi

yellow "* Done"
